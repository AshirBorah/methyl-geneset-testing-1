---
title: "Gene set testing for Illumina HumanMethylation Arrays"
author: "Jovana Maksimovic"
date: "6/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libload, message=FALSE}
library(here)
library(ChAMP)
library(minfi)
library(paletteer)
library(limma)
library(BiocParallel)
library(reshape2)
library(DMRcate)
library(missMethyl)
library(ggplot2)
library(glue)
library(UpSetR)
library(dplyr)
source(here("code/helperFunctions.R"))
source("~/jovanam/R-devel/Bioc-devel/missMethyl/R/goregion.R")
```

# Load data

We are using publicly available EPIC data [GSE110554](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE110554) generated from flow sorted blood cells. The data is normalised and filtered (bad probes, multi-mapping probes, SNP probes, sex chromosomes).

```{r}
# load data
dataFile <- here("data/GSE110554-data.RData")
if(file.exists(dataFile)){
  # load processed data and sample information
  load(dataFile)
} else {
  # get data from experiment hub, normalise, filter and save objects
  readData(dataFile)
  # load processed data and sample information
  load(dataFile)
}
```

# Statistical analysis

Compare several sets of sorted immune cells. Consider results significant at FDR < 0.05 and delta beta ~ 10% (~ lfc = 0.5).

```{r}
mVals <- getM(fltGr)
bVals <- getBeta(fltGr)
```

```{r}
design <- model.matrix(~0+targets$CellType)
colnames(design) <- levels(factor(targets$CellType))
fit <- lmFit(mVals, design)
cont.matrix <- makeContrasts(CD4vCD8=CD4T-CD8T,
                             MonovNeu=Mono-Neu,
                             BcellvNK=Bcell-NK,
                             levels=design)
fit2 <- contrasts.fit(fit, cont.matrix)
tfit <- eBayes(fit2, robust=TRUE, trend=TRUE)
tfit <- treat(tfit, lfc = 0.5)
pval <- 0.05
fitSum <- summary(decideTests(tfit, p.value = pval))
fitSum
```

# Differentially methylated regions

Find differentially methylated regions using the DMRcate package. Investigate three independent contrasts; "B cells vs. NK", "CD4 vs. CD8" and "Mono vs. Neu".

```{r}
contNames <- c("B cells vs. NK", "CD4 vs. CD8", "Mono vs. Neu")
names(contNames) <- c("BcellvNK", "CD4vCD8", "MonovNeu")

dmrFile <- here("data/dmrList.RData")
forceRedo <- FALSE
  
if(!file.exists(dmrFile) | forceRedo){
  dmrList <- vector("list",length(contNames))

  for(i in 1:length(contNames)){
    cpgAnn <- cpg.annotate("array", mVals, what = "M", arraytype = "EPIC",
                             analysis.type = "differential", design = design, 
                             contrasts = TRUE, cont.matrix = cont.matrix, 
                             coef = names(contNames)[i])
    dmrOut <- dmrcate(cpgAnn, lambda = 1000, mc.cores = 10, betacutoff = 0.1, 
                      min.cpgs = 3)

    coord <- dmrOut$results$coord
    coord <- gsub("-",":",coord)
    coord <- strsplit2(coord,":")

    dmrList[[i]] <- GRanges(seqnames = coord[,1], 
                          ranges = IRanges(start = as.numeric(coord[,2]), 
                                    end = as.numeric(coord[,3])),
                          dmrData = dmrOut$results)
  }
  save(dmrList,file = dmrFile)
  
} else {
  load(dmrFile)
  
}
```

```{r}
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
txdb <- TxDb.Hsapiens.UCSC.hg19.knownGene

hg19Genes <- GenomicFeatures::genes(txdb)

goList <- vector("list", length(dmrList))

for(i in 1:length(dmrList)){
  
  overlaps <- findOverlaps(hg19Genes,dmrList[[i]])
  sigGenes <- hg19Genes$gene_id[from(overlaps)]
  goList[[i]] <- topGO(goana(sigGenes),number = Inf)
  goList[[i]]$FDR <- p.adjust(goList[[i]]$P.DE, method = "BH")
}
```

## GO analysis for regions
Run GO analysis on the differentially methylated regions (DMRs) identified by DMRcate for each of the contrasts.

```{r}
dmrGoFile <- here("data/dmr.GO.RData")
forceRedo <- FALSE

anno <- loadAnnotation(arrayType = "EPIC")
 
if(!file.exists(dmrGoFile) | forceRedo){
  
  dmrGO <- lapply(1:length(contNames), function(i){
    hgt <- topGSA(goregion(dmrList[[i]], anno = anno, prior.prob = FALSE, 
                         array.type = "EPIC"), number = Inf)
    gmreg <- topGSA(goregion(dmrList[[i]], anno = anno, 
                           array.type = "EPIC"), number = Inf)
    list(hgt = hgt, gmreg = gmreg)
  })
  
  save(dmrGO, file = dmrGoFile)
  
} else {
  load(dmrGoFile)
  
}
```

### Compare GOregion with standard annotation
```{r, fig.width=9}
immuneGO <- unique(read.csv(here("data/GO-immune-system-process.txt"), 
                            stringsAsFactors = FALSE, header = FALSE, 
                            col.names = "GOID"))
methodNames <- c("goregion-hgt", "goregion-adjust", "genemap-hgt")

  goDat <- numeric(0)
  sub <- 1:50
  
  for(i in 1:length(contNames)){
    
    hgt <- cumsum(rownames(dmrGO[[i]]$hgt) %in% immuneGO$GOID)[sub]
    gmreg <- cumsum(rownames(dmrGO[[i]]$gmreg) %in% immuneGO$GOID)[sub]
    noadj <- cumsum(rownames(goList[[i]]) %in% immuneGO$GOID)[sub]
    
    tmp <- melt(data.frame(hgt, gmreg, noadj, rank=sub), id="rank")
    tmp$contrast <- names(contNames)[i]
    goDat <- rbind(goDat, tmp)  
  }

  p <- ggplot(goDat, aes(x=rank,y=value, colour=variable)) +
    geom_line() +
    facet_wrap(vars(contrast), ncol=3, labeller = labeller(contrast = contNames)) +
    theme_minimal() +
    geom_vline(xintercept = 10, linetype = "dotted") +
    scale_color_paletteer_d(package = "LaCroixColoR", palette = "PassionFruit") +
    labs(colour = "Method") + xlab("Rank") + ylab("Cumulative no. immune sets")
  p

```

```{r, fig.width=5, fig.height=8}
immuneGO <- unique(read.csv(here("data/GO-immune-system-process.txt"), 
                            stringsAsFactors = FALSE, header = FALSE, 
                            col.names = "GOID"))
methodNames <- c("goregion-hgt", "goregion-adjust", "genemap-hgt")

  goDat <- numeric(0)
  sub <- 1:50
  
  for(i in 1){
    
    hgt <- cumsum(rownames(dmrGO[[i]]$hgt) %in% immuneGO$GOID)[sub]
    gmreg <- cumsum(rownames(dmrGO[[i]]$gmreg) %in% immuneGO$GOID)[sub]
    #noadj <- cumsum(rownames(goList[[i]]) %in% immuneGO$GOID)[sub]
    gmprbpval <- cumsum(rownames(probeGO[[i]]$gmprbpval) %in% immuneGO$GOID)[sub]
    
    tmp <- melt(data.frame(hgt, gmreg, gmprbpval, rank=sub), id="rank")
    tmp$contrast <- names(contNames)[i]
    goDat <- rbind(goDat, tmp)  
  }

  p <- ggplot(goDat, aes(x=rank,y=value, colour=variable)) +
    geom_line(size = 1.5) +
    theme_minimal() +
    geom_vline(xintercept = 10, linetype = "dotted") +
    scale_color_paletteer_d(package = "LaCroixColoR", palette = "PassionFruit") +
    labs(colour = "Method") + xlab("Rank") + ylab("Cumulative no. immune sets")
  p

```

```{r, fig.height=8, fig.width=7}
pfPal <- paletteer_d(package = "LaCroixColoR", palette = "PassionFruit")
mar <-  c(4, 32, 2, 3) + 0.1
oma <- c(0, 0, 2, 0)
cex.names <- 1.5
  
for(i in 1:length(contNames)){

  par(mfrow = c(3, 1), mar = mar, oma = oma)
  dat <- head(dmrGO[[i]]$hgt, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[1], col = pfPal[1], 
              cex.names = cex.names)
  
  dat <- head(dmrGO[[i]]$gmreg, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[2], col = pfPal[2], 
              cex.names = cex.names)
  
  dat <- head(goList[[i]], n=10)
  plotTopSets(dat$FDR, dat$Term, dat$N, methodNames[3], col = pfPal[3], 
              cex.names = cex.names)
  
  mtext(contNames[i], outer = TRUE)
  
  #frame()
    
  #par(xpd = TRUE, mar = c(0,0,0,0))
  #plot.new()
  #legend("center", legend = methodNames, 
  #     fill = pfPal, cex = 1.25, title = "Method")
  #legend("topright", legend = "p-value = 0", cex = 1.25, pch = "*")
  #par(xpd = FALSE)
  
}
```

## GO analysis for probes
Run GO analysis on the differentially methylated probes (DMPs) identified by limma for each of the same contrasts. Compare the results from the top 5000 DMPs and all DMPs with FDR < 0.05. 

```{r}
probeGoFile <- here("data/probe.GO.RData")
forceRedo <- FALSE

if(!file.exists(probeGoFile) | forceRedo){
  
  probeGO <- lapply(1:length(contNames), function(i){
      gmprbtop <- topGSA(gometh(rownames(topTreat(tfit, coef = names(contNames)[i], 
                                             num = 5000, p.value = pval)), 
                   anno = anno, array.type = "EPIC"), number = Inf)
      gmprbpval <- topGSA(gometh(rownames(topTreat(tfit, coef = names(contNames)[i], 
                                             num = Inf, p.value = pval)), 
                          anno = anno, array.type = "EPIC"), number = Inf)
      
      list(gmprbtop = gmprbtop, gmprbpval = gmprbpval)
  })
  save(probeGO, file = probeGoFile)
  
} else {
  load(probeGoFile)
  
}
```

As we are comparing immune cells, we expect GO categories related to the immune system and its processes to be highly ranked. To evalue this, we downloaded all of the child terms for the GO category "immune system process" (GO:002376) from AminGO 2;  [http://amigo.geneontology.org/amigo/term/GO:0002376](http://amigo.geneontology.org/amigo/term/GO:0002376). 

```{r, fig.width=9}
immuneGO <- unique(read.csv(here("data/GO-immune-system-process.txt"), 
                            stringsAsFactors = FALSE, header = FALSE, 
                            col.names = "GOID"))
methodNames <- c("hgt", "gometh-region", "gometh-probe-top", 
                 "gometh-probe-pval")

  goDat <- numeric(0)
  sub <- 1:50
  
  for(i in 1:length(contNames)){
    
    hgt <- cumsum(rownames(dmrGO[[i]]$hgt) %in% immuneGO$GOID)[sub]
    gmreg <- cumsum(rownames(dmrGO[[i]]$gmreg) %in% immuneGO$GOID)[sub]
    gmprbtop <- cumsum(rownames(probeGO[[i]]$gmprbtop) %in% immuneGO$GOID)[sub]
    gmprbpval <- cumsum(rownames(probeGO[[i]]$gmprbpval) %in% immuneGO$GOID)[sub]
    
    tmp <- melt(data.frame(hgt, gmreg, gmprbtop, gmprbpval, rank=sub), id="rank")
    tmp$contrast <- names(contNames)[i]
    goDat <- rbind(goDat, tmp)  
  }

  p <- ggplot(goDat, aes(x=rank,y=value, colour=variable)) +
    geom_line() +
    facet_wrap(vars(contrast), ncol=3, labeller = labeller(contrast = contNames)) +
    theme_minimal() +
    geom_vline(xintercept = 10, linetype = "dotted") +
    scale_color_paletteer_d(package = "LaCroixColoR", palette = "PassionFruit",
                            labels = methodNames) +
    labs(colour = "Method") + xlab("Rank") + ylab("Cumulative no. immune sets")
  p

```

```{r, fig.width=5, fig.height=8}
immuneGO <- unique(read.csv(here("data/GO-immune-system-process.txt"), 
                            stringsAsFactors = FALSE, header = FALSE, 
                            col.names = "GOID"))
methodNames <- c("hgt", "gometh-region", "gometh-probe-top", 
                 "gometh-probe-pval")

  goDat <- numeric(0)
  sub <- 1:50
  
  for(i in 1){
    
    hgt <- cumsum(rownames(dmrGO[[i]]$hgt) %in% immuneGO$GOID)[sub]
    gmreg <- cumsum(rownames(dmrGO[[i]]$gmreg) %in% immuneGO$GOID)[sub]
    gmprbtop <- cumsum(rownames(probeGO[[i]]$gmprbtop) %in% immuneGO$GOID)[sub]
    gmprbpval <- cumsum(rownames(probeGO[[i]]$gmprbpval) %in% immuneGO$GOID)[sub]
    
    tmp <- melt(data.frame(hgt, gmreg, gmprbtop, gmprbpval, rank=sub), id="rank")
    tmp$contrast <- names(contNames)[i]
    goDat <- rbind(goDat, tmp)  
  }

  p <- ggplot(goDat, aes(x=rank,y=value, colour=variable)) +
    geom_line(size = 1.5) +
    theme_minimal() +
    geom_vline(xintercept = 10, linetype = "dotted") +
    scale_color_paletteer_d(package = "LaCroixColoR", palette = "PassionFruit",
                            labels = methodNames) +
    labs(colour = "Method") + xlab("Rank") + ylab("Cumulative no. immune sets")
  p

```

Examine what the top 10 ranked gene sets are and how many genes (N) they contain, for each method and comparison.

```{r, fig.width=10, fig.height=8}
pfPal <- paletteer_d(package = "LaCroixColoR", palette = "PassionFruit")
mar <-  c(4, 21, 2, 3) + 0.1
oma <- c(0, 0, 2, 0)
cex.names <- 0.75
  
for(i in 1:length(contNames)){

  par(mfrow = c(3, 2), mar = mar, oma = oma)
  dat <- head(dmrGO[[i]]$hgt, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[1], col = pfPal[1], 
              cex.names = cex.names)
  
  dat <- head(dmrGO[[i]]$gmreg, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[2], col = pfPal[2], 
              cex.names = cex.names)
  
  dat <- head(probeGO[[i]]$gmprbtop, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[3], col = pfPal[3], 
              cex.names = cex.names)
  
  dat <- head(probeGO[[i]]$gmprbpval, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[4], col = pfPal[4], 
              cex.names = cex.names)
  
  mtext(contNames[i], outer = TRUE)
  
  frame()
    
  par(xpd = TRUE, mar = c(0,0,0,0))
  plot.new()
  legend("center", legend = methodNames, 
       fill = pfPal, cex = 1.25, title = "Method")
  #legend("topright", legend = "p-value = 0", cex = 1.25, pch = "*")
  par(xpd = FALSE)
  
}
```

```{r, fig.height=12, fig.width=7}
pfPal <- paletteer_d(package = "LaCroixColoR", palette = "PassionFruit")
mar <-  c(4, 33, 2, 3) + 0.1
oma <- c(0, 0, 2, 0)
cex.names <- 1.5
  
for(i in 1:length(contNames)){

  par(mfrow = c(4, 1), mar = mar, oma = oma)
  dat <- head(dmrGO[[i]]$hgt, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[1], col = pfPal[1], 
              cex.names = cex.names)
  
  dat <- head(dmrGO[[i]]$gmreg, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[2], col = pfPal[2], 
              cex.names = cex.names)
  
  dat <- head(probeGO[[i]]$gmprbtop, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[3], col = pfPal[3], 
              cex.names = cex.names)
  
  dat <- head(probeGO[[i]]$gmprbpval, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[4], col = pfPal[4], 
              cex.names = cex.names)
  
  mtext(contNames[i], outer = TRUE)
}
```

## Compare results of region-wise and probe-wise analyses
Explore the list of CpGs and genes identified by each approach. The proportion of CpGs mapped to a gene is always highest for the region-wise approach.    

```{r, fig.height=7, fig.width=9}
cpgs <- GRanges(seqnames = anno$chr, 
                  ranges = IRanges(start = anno$pos, 
                                   end = anno$pos),
                  strand = anno$strand,
                  name = anno$Name)

probeTopCpgs <- vector("list",length(contNames))
probeTopGenes <- vector("list",length(contNames))
probePvalCpgs <- vector("list",length(contNames))
probePvalGenes <- vector("list",length(contNames))
dmrCpgs <- vector("list",length(contNames))
dmrGenes <- vector("list",length(contNames))

flatAnn <- loadFlatAnnotation(anno)

mpPal <- paletteer_d(package = "LaCroixColoR", palette = "MurePepino")
names.arg <- c("Probe-wise\n(Top 5000)","Probe-wise\n(FDR < 0.05)","Region-wise")
  
for(i in 1:length(contNames)){
  
  overlaps <- findOverlaps(cpgs,dmrList[[i]])
  dmrCpgs[[i]] <- cpgs$name[from(overlaps)]

  probeTopCpgs[[i]] <- rownames(topTreat(tfit, coef = names(contNames)[i], 
                                             num = 5000, p.value = pval))
  probePvalCpgs[[i]] <- rownames(topTreat(tfit, coef = names(contNames)[i], 
                                             num = Inf, p.value = pval))
  probeTopGenes[[i]] <- flatAnn[flatAnn$cpg %in% probeTopCpgs[[i]],]
  probePvalGenes[[i]] <- flatAnn[flatAnn$cpg %in% probePvalCpgs[[i]],]
  dmrGenes[[i]] <- flatAnn[flatAnn$cpg %in% dmrCpgs[[i]],]
  
  par(mfrow=c(2,2), mar = c(3, 4, 2, 1) + 0.1, oma = c(2, 0, 2, 0))
  barplot(rbind(length(probeTopCpgs[[i]]), length(probePvalCpgs[[i]]), 
                length(dmrCpgs[[i]])), ylab = "No. significant CpGs", 
          beside = TRUE, col = mpPal, names.arg = names.arg, cex.names = 0.8)
  
  barplot(rbind(sum(probeTopCpgs[[i]] %in% unique(flatAnn$cpg))/length(probeTopCpgs[[i]]),
                sum(probePvalCpgs[[i]] %in% unique(flatAnn$cpg))/length(probePvalCpgs[[i]]),
                sum(dmrCpgs[[i]] %in% unique(flatAnn$cpg))/length(dmrCpgs[[i]])), 
          ylim=c(0,1), ylab = "Prop. CpGs mapped to a gene", beside = TRUE,
          col = mpPal, names.arg = names.arg, cex.names = 0.8)
    
  barplot(rbind(length(unique(probeTopGenes[[i]]$entrezid)),
                length(unique(probePvalGenes[[i]]$entrezid)),
                length(unique(dmrGenes[[i]]$entrezid))),
          ylab = "No. genes covered", beside = TRUE, col = mpPal,
          names.arg = names.arg, cex.names = 0.8)
  
  barplot(rbind(table(probeTopGenes[[i]]$group),
                table(probePvalGenes[[i]]$group),
                table(dmrGenes[[i]]$group)), beside = TRUE, las = 2,
          legend.text = gsub("\n", " ", names.arg), ylab = "No. CpGs mapped to feature", col = mpPal[1:3],
          args.legend = list(title = c("Analysis type"), cex = 0.8), cex.axis = 0.8)
  
  mtext(contNames[i], outer = TRUE)
}
```

## CpG overlap between region-wise and probe-wise approaches

Compare the CpG lists produced by the different approaches, for the three contrasts.

```{r}
upsetCpgs <- list(Top=probeTopCpgs[[1]], P.Value=probePvalCpgs[[1]], Region=dmrCpgs[[1]])
upset(fromList(upsetCpgs), order.by = "freq", keep.order = TRUE, sets = c("Top","P.Value","Region"))
  
upsetCpgs <- list(Top=probeTopCpgs[[2]], P.Value=probePvalCpgs[[2]], Region=dmrCpgs[[2]])
upset(fromList(upsetCpgs), order.by = "freq", keep.order = TRUE, sets = c("Top","P.Value","Region"))
  
upsetCpgs <- list(Top=probeTopCpgs[[3]], P.Value=probePvalCpgs[[3]], Region=dmrCpgs[[3]])
upset(fromList(upsetCpgs), order.by = "freq", keep.order = TRUE, sets = c("Top","P.Value","Region"))
```

## Gene overlap between region-wise and probe-wise approaches

Compare the genes covered by the different approaches, for the three contrasts.

```{r}
upsetGenes <- list(Top=probeTopGenes[[1]]$entrezid, P.Value=probePvalGenes[[1]]$entrezid, Region=dmrGenes[[1]]$entrezid)
upset(fromList(upsetGenes), order.by = "freq", keep.order = TRUE, sets = c("Top","P.Value","Region"))
  
upsetGenes <- list(Top=probeTopGenes[[2]]$entrezid, P.Value=probePvalGenes[[2]]$entrezid, Region=dmrGenes[[2]]$entrezid)
upset(fromList(upsetGenes), order.by = "freq", keep.order = TRUE, sets = c("Top","P.Value","Region"))
  
upsetGenes <- list(Top=probeTopGenes[[3]]$entrezid, P.Value=probePvalGenes[[3]]$entrezid, Region=dmrGenes[[3]]$entrezid)
upset(fromList(upsetGenes), order.by = "freq", keep.order = TRUE, sets = c("Top","P.Value","Region"))
```

How important are region cut offs i.e. num probes in region and delta beta?

```{r}
dmrParamFile <- here("data/dmrParams.RData")
forceRedo <- FALSE

params <- data.frame(betacutoff = rep(c("NULL", 0.1, 0.2), times = 3), 
                     min.cpgs = rep(c(2, 3, 4), each = 3), stringsAsFactors = FALSE)

if(!file.exists(dmrParamFile) | forceRedo){
  dmrParamList <- vector("list", nrow(params))
  
  cpgAnn <- cpg.annotate("array", mVals, what = "M", arraytype = "EPIC",
                             analysis.type = "differential", design = design, 
                             contrasts = TRUE, cont.matrix = cont.matrix, 
                             coef = "CD4vCD8")
    
  for(i in 1:nrow(params)){
    
    if(params$betacutoff[i] == "NULL"){
      betacutoff = NULL
      
    } else {
      betacutoff = params$betacutoff[i]
      
    }
    
    dmrOut <- dmrcate(cpgAnn, lambda = 1000, mc.cores = 10, 
                      betacutoff = betacutoff, 
                      min.cpgs = params$min.cpgs[i])

    coord <- dmrOut$results$coord
    coord <- gsub("-",":",coord)
    coord <- strsplit2(coord,":")

    dmrParamList[[i]] <- GRanges(seqnames = coord[,1], 
                          ranges = IRanges(start = as.numeric(coord[,2]), 
                                    end = as.numeric(coord[,3])),
                          dmrData = dmrOut$results)
  }
  save(dmrParamList, file = dmrParamFile)
  
} else {
  load(dmrParamFile)
  
}
```

```{r}
dmrParamGoFile <- here("data/dmr.param.GO.RData")
forceRedo <- FALSE

if(!file.exists(dmrParamGoFile) | forceRedo){

  dmrParamGO <- lapply(1:length(dmrParamList), function(i){
    gmreg <- topGSA(goregion(dmrParamList[[i]], anno = anno, 
                           array.type = "EPIC"), number = Inf)
    list(gmreg = gmreg)
  })
  
  save(dmrParamGO, file = dmrParamGoFile)
  
} else {
  load(dmrParamGoFile)
  
}
```


```{r, fig.width=8}
  goDat <- numeric(0)
  sub <- 1:50
  
  for(i in 1:length(dmrParamGO)){
    
    tmp <- data.frame(value=cumsum(rownames(dmrParamGO[[i]]$gmreg) %in% immuneGO$GOID)[sub],
                      rank=sub, variable=factor(i))
    goDat <- rbind(goDat, tmp)  
  }

  paramLabels <- glue("\u0394\u03b2= {params$betacutoff}, Min. CpGs = {params$min.cpgs}")

  goDat$betacut <- factor(rep(params$betacutoff, each=max(sub)))
  goDat$mincpgs <- factor(rep(params$min.cpgs, each=max(sub)))
  
  p <- ggplot(goDat, aes(x=rank,y=value, colour=mincpgs), group=betacut) +
    geom_line(aes(linetype=betacut)) +
    theme_minimal() +
    geom_vline(xintercept = 10, linetype = "dotted") +
    scale_color_paletteer_d(package = "wesanderson", palette = "Darjeeling1") +
    scale_linetype_manual(values=c("solid", "longdash", "dotdash")) +
    labs(linetype = "\u0394\u03b2", colour = "Min. CpGs") + xlab("Rank") + 
    ylab("Cumulative no. immune sets")
  p

```

## Different region finding methods

```{r}
maxGap <- 300 # max distance between probes in same cluster
minProbes <- 7 # valid cluster must have > minProbes
cores <- 10 # num. cores to use for bootstraps
B <- 1000 # num. bootstraps
adjP <- 0.05
dmrFile <- here("data/dmrsList.RData") # name of results file
inputFile <- here("data/dmrsInputs.RData") # saved input objects
save(tfit, bVals, mVals, targets, file = inputFile)

forceRedo <- FALSE

if(!file.exists(dmrFile) | forceRedo){
  scriptFile <- here("code/runDmrMethods.R")
  runBgAnalysis(scriptFile, outPrefix = "dmr",
                args = c(maxGap, minProbes, cores, B, betacut, adjP, dmrFile, inputFile))
  
} else {
  load(dmrFile)
}
```


```{r}
dmrGoFile <- here("data/dmrsGO.RData")
forceRedo <- FALSE

if(!file.exists(dmrGoFile) | forceRedo){

  anno <- loadAnnotation(arrayType = "EPIC")
  dmrGO <- lapply(1:length(dmrList), function(i){
    
    hgt <- lapply(dmrList[[i]], function(res){
      
      r <- res[[1]]
      g <- GRanges(seqnames = Rle(as.character(r$seqnames)), 
                 ranges = IRanges(start = r$start, end = r$end))
    
      topGSA(goregion(g, anno = anno, prior.prob = FALSE, array.type = "EPIC"), 
             number = Inf)
    })
    
    gmreg <- lapply(dmrList[[i]], function(res){
      
      r <- res[[1]]
      g <- GRanges(seqnames = Rle(as.character(r$seqnames)), 
                 ranges = IRanges(start = r$start, end = r$end))
    
      topGSA(goregion(g, anno = anno, prior.prob = TRUE, array.type = "EPIC"), 
             number = Inf)
    })

    list(hgt = hgt, gmreg = gmreg)
  })

  save(dmrGO, file = dmrGoFile)

} else {
  load(dmrGoFile)

}
```

<!-- ```{r} -->
<!-- bumpCpgs <- vector("list", length(contNames)) -->

<!-- for(i in 1:length(contNames)){ -->

<!--   overlaps <- findOverlaps(cpgs,bumpList[[i]]) -->
<!--   bumpCpgs[[i]] <- cpgs$name[from(overlaps)] -->
<!-- } -->
<!-- ``` -->

```{r, fig.width=9}
  goDat <- numeric(0)
  sub <- 1:200

  for(i in 1:length(dmrGO)){

    hgt.dmrc <- cumsum(rownames(dmrGO[[i]]$hgt$dmrc) %in% immuneGO$GOID)[sub]
    hgt.bumph <- cumsum(rownames(dmrGO[[i]]$hgt$bumph) %in% immuneGO$GOID)[sub]
    hgt.probel <- cumsum(rownames(dmrGO[[i]]$hgt$probel) %in% immuneGO$GOID)[sub]
    
    gmreg.dmrc <- cumsum(rownames(dmrGO[[i]]$gmreg$dmrc) %in% immuneGO$GOID)[sub]
    gmreg.bumph <- cumsum(rownames(dmrGO[[i]]$gmreg$bumph) %in% immuneGO$GOID)[sub]
    gmreg.probel <- cumsum(rownames(dmrGO[[i]]$gmreg$probel) %in% immuneGO$GOID)[sub]
    
    #gmprbtop <- cumsum(rownames(probeGO[[i]]$gmprbtop) %in% immuneGO$GOID)[sub]
    #gmprbpval <- cumsum(rownames(probeGO[[i]]$gmprbpval) %in% immuneGO$GOID)[sub]

    #tmp <- melt(data.frame(hgt, gmreg, gmprbtop, gmprbpval, rank=sub), id="rank")
    hgt <- melt(data.frame(dmrc = hgt.dmrc, bumph=hgt.bumph, probel=hgt.probel, 
                           rank = sub), id="rank")
    hgt$method <- "hgt"
    gmreg <- melt(data.frame(dmrc = gmreg.dmrc, bumph=gmreg.bumph, probel=gmreg.probel, 
                             rank = sub), id="rank")
    gmreg$method <- "gmreg"
    tmp <- rbind(hgt, gmreg)
    #tmp <- melt(data.frame(hgt.dmrc, hgt.bumph, hgt.probel,
    #                       gmreg.dmrc, gmreg.bumph, gmreg.probel, rank=sub), id="rank")
    tmp$contrast <- colnames(tfit$contrasts)[i]
    goDat <- rbind(goDat, tmp)
  }

  p <- ggplot(goDat, aes(x=rank,y=value, colour=method)) +
    geom_line() +
    facet_wrap(vars(variable, contrast), ncol=3, scales = "free_y", 
               labeller = labeller(contrast = contNames)) +
    theme_minimal() +
  #  geom_vline(xintercept = 10, linetype = "dotted") +
    scale_color_paletteer_d(package = "LaCroixColoR", palette = "PassionFruit") +
    labs(colour = "Method") + xlab("Rank") + ylab("Cumulative no. immune sets")
  p

```

<!-- ```{r, fig.width=9} -->
<!--   goDat <- numeric(0) -->
<!--   pcuts <- c(0.0001, 0.001, 0.01, 0.05, 0.1) -->

<!--   propSig <- function(pcuts, result){ -->
<!--     sapply(pcuts, function(p){ -->
<!--       sum(rownames(result)[result$FDR < p] %in% immuneGO$GOID)/nrow(result) -->
<!--     }) -->
<!--   } -->

<!--   for(i in 1:length(dmrGO)){ -->

<!--     hgt.dmrc <- propSig(pcuts, dmrGO[[i]]$hgt$dmrc) -->
<!--     hgt.bumph <- propSig(pcuts, dmrGO[[i]]$hgt$bumph) -->
<!--     hgt.probel <- propSig(pcuts, dmrGO[[i]]$hgt$probel) -->

<!--     gmreg.dmrc <- propSig(pcuts, dmrGO[[i]]$gmreg$dmrc) -->
<!--     gmreg.bumph <- propSig(pcuts, dmrGO[[i]]$gmreg$bumph) -->
<!--     gmreg.probel <- propSig(pcuts, dmrGO[[i]]$gmreg$probel) -->

<!--     hgt <- melt(data.frame(dmrc = hgt.dmrc, bumph=hgt.bumph, probel=hgt.probel,  -->
<!--                            pval = pcuts), id="pval") -->
<!--     hgt$method <- "hgt" -->
<!--     gmreg <- melt(data.frame(dmrc = gmreg.dmrc, bumph=gmreg.bumph, probel=gmreg.probel,  -->
<!--                              pval = pcuts), id="pval") -->
<!--     gmreg$method <- "gmreg" -->
<!--     tmp <- rbind(hgt, gmreg) -->
<!--     tmp$contrast <- colnames(tfit$contrasts)[i] -->
<!--     goDat <- rbind(goDat, tmp) -->
<!--   } -->

<!--   p <- ggplot(goDat, aes(x=pval,y=value, colour=method)) + -->
<!--     geom_line() + -->
<!--     facet_wrap(vars(variable, contrast), ncol=3, scales = "free_y",  -->
<!--                labeller = labeller(contrast = contNames)) + -->
<!--     theme_minimal() + -->
<!--   #  geom_vline(xintercept = 10, linetype = "dotted") + -->
<!--     scale_color_paletteer_d(package = "LaCroixColoR", palette = "PassionFruit") + -->
<!--     labs(colour = "Method") + xlab("Rank") + ylab("Cumulative no. immune sets") -->
<!--   p -->

<!-- ``` -->

```{r, fig.height=8, fig.width=9}
pfPal <- paletteer_d(package = "LaCroixColoR", palette = "PassionFruit")
mar <-  c(4, 22, 2, 3) + 0.1
oma <- c(2, 0, 2, 0)

for(i in 1:length(contNames)){

  par(mfrow = c(3, 2), mar = mar, oma = oma)
  dat <- head(dmrGO[[i]]$hgt$dmrc, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[1], col = pfPal[1], cex.names = 0.7,
              main = "DMRcate")

  dat <- head(dmrGO[[i]]$gmreg$dmrc, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[2], col = pfPal[2], cex.names = 0.7,
              main = "DMRcate")

  dat <- head(dmrGO[[i]]$hgt$bumph, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[1], col = pfPal[1], cex.names = 0.7,
              main = "Bumphunter")

  dat <- head(dmrGO[[i]]$gmreg$bumph, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[2], col = pfPal[2], cex.names = 0.7,
              main = "Bumphunter")

  dat <- head(dmrGO[[i]]$hgt$probel, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[1], col = pfPal[1], cex.names = 0.7,
              main = "ProbeLasso")

  dat <- head(dmrGO[[i]]$gmreg$probel, n=10)
  plotTopSets(dat$FDR, dat$TERM, dat$N, methodNames[2], col = pfPal[2], cex.names = 0.7,
              main = "ProbeLasso")

  mtext(colnames(tfit$contrasts)[i], outer = TRUE)

  # par(xpd = TRUE, mar = c(5,4,4,2))
  # plot.new()
  # legend("center", legend = methodNames,
  #      fill = pfPal, cex = 1.25, title = "Method")
  # #legend("topright", legend = "p-value = 0", cex = 1.25, pch = "*")
  # par(xpd = FALSE)
}
```

```{r}
  dmrRanges <- lapply(1:length(dmrList), function(i){
    
    lapply(dmrList[[i]], function(res){
      
      r <- res[[1]]
      GRanges(seqnames = Rle(as.character(r$seqnames)), 
              ranges = IRanges(start = r$start, end = r$end))
    })
  })
  
cpgs <- GRanges(seqnames = anno$chr, 
                  ranges = IRanges(start = anno$pos, 
                                   end = anno$pos),
                  strand = anno$strand,
                  name = anno$Name)

dmrStats <- lapply(dmrRanges, function(contr){
  lapply(contr, function(method){
    
    overlaps <- findOverlaps(cpgs,method)
    sig.cpg <- cpgs$name[from(overlaps)]
    sig.eg <- getMappedEntrezIDs(sig.cpg = sig.cpg, array.type = "EPIC", anno=anno)$sig.eg
    list(sig.cpg = sig.cpg, sig.eg = sig.eg)
  })
})


```

```{r}
dmrDat <- lapply(1:length(dmrRanges), function(i){
  data.frame(reshape2::melt(list(dmrc = width(dmrRanges[[i]]$dmrc), 
                      bumph = width(dmrRanges[[i]]$bumph),
                      probel = width(dmrRanges[[i]]$probel))), 
             contrast=colnames(tfit$contrasts)[i])
})

dmrDat <- bind_rows(dmrDat)

p <- ggplot(dmrDat, aes(x=L1, y = value, fill = contrast)) + 
  geom_boxplot() +
  labs(x = "Region finding method", y = "Region width") +
  theme_minimal()
p
```

```{r}
dmrDat <- lapply(1:length(dmrStats), function(i) {
  melt(data.frame(dmrc = length(dmrStats[[i]]$dmrc$sig.cpg),
             bumph = length(dmrStats[[i]]$bumph$sig.cpg),
             probel = length(dmrStats[[i]]$probel$sig.cpg),
             contrast = colnames(tfit$contrasts)[i]))
})

dmrDat <- bind_rows(dmrDat)

p <- ggplot(dmrDat, aes(x=variable, y = value, fill = contrast)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  labs(x = "Region finding method", y = "No. CpGs covered by regions") +
  theme_minimal()
p
```

```{r}
dmrDat <- lapply(1:length(dmrStats), function(i) {
  melt(data.frame(dmrc = length(dmrStats[[i]]$dmrc$sig.eg),
             bumph = length(dmrStats[[i]]$bumph$sig.eg),
             probel = length(dmrStats[[i]]$probel$sig.eg),
             contrast = colnames(tfit$contrasts)[i]))
})

dmrDat <- bind_rows(dmrDat)

p <- ggplot(dmrDat, aes(x=variable, y = value, fill = contrast)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  labs(x = "Region finding method", y = "No. genes covered by regions") +
  theme_minimal()
p
```

```{r}
usDmrCpgs <- list(DMRcate=dmrStats[[1]]$dmrc$sig.cpg, 
                  Bumphunter=dmrStats[[1]]$bumph$sig.cpg, 
                  ProbeLasso=dmrStats[[1]]$probel$sig.cpg)
upset(fromList(usDmrCpgs), order.by = "freq", keep.order = TRUE, 
      sets = c("DMRcate","Bumphunter","ProbeLasso"))

usDmrCpgs <- list(DMRcate=dmrStats[[2]]$dmrc$sig.cpg, 
                  Bumphunter=dmrStats[[2]]$bumph$sig.cpg, 
                  ProbeLasso=dmrStats[[2]]$probel$sig.cpg)
upset(fromList(usDmrCpgs), order.by = "freq", keep.order = TRUE, 
      sets = c("DMRcate","Bumphunter","ProbeLasso"))

usDmrCpgs <- list(DMRcate=dmrStats[[3]]$dmrc$sig.cpg, 
                  Bumphunter=dmrStats[[3]]$bumph$sig.cpg, 
                  ProbeLasso=dmrStats[[3]]$probel$sig.cpg)
upset(fromList(usDmrCpgs), order.by = "freq", keep.order = TRUE, 
      sets = c("DMRcate","Bumphunter","ProbeLasso"))
```

```{r}
usDmrGenes <- list(DMRcate=dmrStats[[1]]$dmrc$sig.eg, 
                  Bumphunter=dmrStats[[1]]$bumph$sig.eg, 
                  ProbeLasso=dmrStats[[1]]$probel$sig.eg)
upset(fromList(usDmrGenes), order.by = "freq", keep.order = TRUE, 
      sets = c("DMRcate","Bumphunter","ProbeLasso"))

usDmrGenes <- list(DMRcate=dmrStats[[2]]$dmrc$sig.eg, 
                  Bumphunter=dmrStats[[2]]$bumph$sig.eg, 
                  ProbeLasso=dmrStats[[2]]$probel$sig.eg)
upset(fromList(usDmrGenes), order.by = "freq", keep.order = TRUE, 
      sets = c("DMRcate","Bumphunter","ProbeLasso"))

usDmrGenes <- list(DMRcate=dmrStats[[3]]$dmrc$sig.eg, 
                  Bumphunter=dmrStats[[3]]$bumph$sig.eg, 
                  ProbeLasso=dmrStats[[3]]$probel$sig.eg)
upset(fromList(usDmrGenes), order.by = "freq", keep.order = TRUE, 
      sets = c("DMRcate","Bumphunter","ProbeLasso"))
```

