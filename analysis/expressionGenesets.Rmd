---
title: "Salmon quasi-mapping with limma-voom analysis"
output:
  html_document:
    df_print: paged
---

```{r, message=FALSE, echo=FALSE}
library(tximport)
library(here)
library(tidyverse)
library(EnsDb.Hsapiens.v75)
library(readr)
library(limma)
library(edgeR)
library(EGSEA)
library(EGSEAdata)
```

# Data import

The data was quasi-mapped and quantified using Salmon (v1.2.1) with the hg19_cdna Ensembl human transcriptome.  

Load sample information and file names.

```{r}
targets <- read_csv(here("data/SRP125125/SraRunTableFull.txt"))
targets$Cell_type <- gsub(" ", "_", targets$Cell_type)
targets$Cell_type <- gsub("-", "_", targets$Cell_type)
targets
```

```{r, echo=FALSE}
files <- list.files(here("data/SRP125125/quants"), 
                    recursive = TRUE, pattern = "quant.sf", full.names = TRUE)
names(files) <- substr(strsplit2(files, "/")[,10], 1, 10)
```

Associate transcripts with gene IDs for gene-level summarization.

```{r, echo=FALSE}
edb <- EnsDb.Hsapiens.v75
tx2gene <- transcripts(edb, columns = c("tx_id", "gene_id"), 
                       return.type = "DataFrame")
tx2gene
```

Import gene-level counts and abundances.

```{r, echo=FALSE}
txiG <- tximport(files, type = "salmon", tx2gene = tx2gene, 
                  countsFromAbundance = "lengthScaledTPM", 
                  ignoreTxVersion = TRUE)
colnames(txiG$counts) <- names(files)
head(txiG$counts)
```

Set up `DGElist` object for downstream analysis.

```{r, echo=FALSE}
z <- DGEList(txiG$counts)
z$genes <- ensembldb::genes(edb, filter = GeneIdFilter(rownames(z)), 
                 columns = c("gene_id", "symbol", "entrezid"), 
                 return.type = "DataFrame")
z$genes$entrezid <- sapply(z$genes$entrezid, function(x) x[1])
z$genes$length <- rowMedians(txiG$length)
targets <- targets[match(colnames(z), targets$Run), ]
z$samples$group <- targets$Cell_type
z
```

# Quality control

Genes that do not have an adequate number of reads in any sample should be filtered out prior to downstream analyses. From a biological perspective, genes that are not expressed at a biologically meaningful level in any condition are not of interest. Statistically, we get a better estimate of the mean-variance relationship in the data and reduce the number of statistical tests that are performes during differential expression analyses.

Filter out lowly expressed genes and calculate TMM normalisation factors.

```{r, echo=FALSE}
keep <- filterByExpr(z, group = z$group)
x <- z[keep, ]
y <- calcNormFactors(x)
y
```

Plotting the distribution log-CPM values shows that a majority of genes within each sample are either not expressed or lowly-expressed with log-CPM values that are small or negative.

```{r, echo=FALSE}
L <- mean(z$samples$lib.size) * 1e-6
M <- median(z$samples$lib.size) * 1e-6

par(mfrow=c(1,2))
lcpmz <- cpm(z, log = TRUE)
lcpm.cutoff <- log2(10/M + 2/L)
nsamples <- ncol(z)
col <- paletteer_d("Polychrome::dark", 24)
plot(density(lcpmz[,1]), col=col[1], lwd=2, ylim=c(0,0.75), las=2, main="", xlab="")
title(main="Unfiltered data", xlab="Log-cpm")
abline(v=lcpm.cutoff, lty=3)
for (i in 2:nsamples){
  den <- density(lcpmz[,i])
  lines(den$x, den$y, col=col[i], lwd=2)
}

lcpmy <- cpm(y, log=TRUE)
plot(density(lcpmy[,1]), col=col[1], lwd=2, ylim=c(0,0.15), las=2, main="", xlab="")
title(main="Filtered data", xlab="Log-cpm")
abline(v=lcpm.cutoff, lty=3)
for (i in 2:nsamples){
  den <- density(lcpmy[,i])
  lines(den$x, den$y, col=col[i], lwd=2)
}
```


```{r, fig.height=8, fig.width=9, echo=FALSE}
pal <- paletteer_d("LaCroixColoR::paired", 14)

par(mar=c(5,6,4,2)+0.1, mfrow=c(2,2))
barplot(y$samples$lib.size, col=pal[factor(targets$Cell_type)], cex.names = 0.8, 
        names.arg = colnames(y), las = 2, main = "Library size", yaxt = "none")
aty <- seq(0, 14000000, by = 2000000)
axis(2, at=aty, labels=format(aty, scientific=FALSE), las=2, cex = 0.8)
legend("topright", legend = levels(factor(targets$Cell_type)), fill = pal)

par(mar=c(5,3,4,2)+0.1)
boxplot(cpm(x, log=TRUE), las=2, col=pal[factor(targets$Cell_type)], 
        main="Unnormalised log2 CPM")
legend("topright", legend = levels(factor(targets$Cell_type)), fill = pal)

par(mar=c(5,3,4,2)+0.1)
boxplot(cpm(y, log=TRUE), las=2, col=pal[factor(targets$Cell_type)], 
        main="Normalised log2 CPM")
legend("topright", legend = levels(factor(targets$Cell_type)), fill = pal)

```

Multi-dimensional scaling (MDS) plots show the largest sources of variation in the data. They are a good way of exploring the relationships between the samples and identifying structure in the data. The following series of MDS plots examines the first four principal components. The samples are coloured by various known features of the samples such as CMV result and foetal sex. The MDS plots do not show the samples obviously clustering by any of the known features of the data. This indicates that we are unlikely to find many differentially expressed genes between CMV and normal samples.

```{r, fig.height=8, fig.width=9, echo=FALSE}
lcpm <- cpm(y, log = TRUE)

par(mfrow=c(2,2), oma = c(0,0,2,0))
plotMDS(lcpm, gene.selection = "common", pch = 19,
        col = pal[factor(targets$Cell_type)])
legend("topleft", legend = levels(factor(targets$Cell_type)), text.col = pal,
       cex = 0.7)
plotMDS(lcpm, gene.selection = "common", pch = 19,
        col = pal[factor(targets$Cell_type)], dim.plot = c(1,3))
legend("topright", legend = levels(factor(targets$Cell_type)), text.col = pal,
       cex = 0.7)
plotMDS(lcpm, gene.selection = "common", pch = 19,
        col = pal[factor(targets$Cell_type)], dim.plot = c(2,3))
legend("topright", legend = levels(factor(targets$Cell_type)), text.col = pal,
       cex = 0.7)
plotMDS(lcpm, gene.selection = "common", pch = 19,
        col = pal[factor(targets$Cell_type)], dim.plot = c(3,4))
legend("topleft", legend = levels(factor(targets$Cell_type)), text.col = pal,
       cex = 0.7)
```

# Differential expression analysis
The TMM normalised data was transformed using `voomWithQualityWeights`. This takes into account the differing library sizes and the mean variance relationship in the data as well as calculating sample-specific quality weights. Linear models were fit in `limma`, taking into account the `voom` weights. 

```{r, echo=FALSE}
design <- model.matrix(~0+y$samples$group, data = targets)
colnames(design) <- c(levels(factor(y$samples$group)))
v <- voomWithQualityWeights(y, design, plot = TRUE)
cont <- makeContrasts(CD4vCD8=Naive_CD4_T_cells-Naive_CD8_T_cells,
                      MonovNeu=Classical_monocytes-Low_density_neutrophils,
                      BcellvNK=Naive_B_cells-Natural_killer_cells,
                      levels=design)
fit <- lmFit(v, design)
cfit <- contrasts.fit(fit, cont)
fit2 <- eBayes(cfit, robust = TRUE)
summary(decideTests(fit2, p.value = 0.05))
```

# Gene set testing

Testing for enrichment of GO categories and KEGG pathways amongst statistically significant differentially expressed genes.

```{r, echo=FALSE}
for(i in 1:ncol(cont)){
    top <- topTable(fit2, coef = i, p.value = 0.05, number = Inf)
    
    go <- goana(top$entrezid, universe = y$genes$entrezid, trend = "length")
    go <- topGO(go, number = Inf)
    go$FDR <- p.adjust(go$P.DE)
    write.csv(go, here(glue("code/{colnames(cont)[i]}.GO.csv")))
    
    kegg <- kegga(top$entrezid, universe = y$genes$entrezid, trend="length")
    kegg <- topKEGG(kegg, number = Inf)
    kegg$FDR <- p.adjust(kegg$P.DE)
    write.csv(kegg, here(glue("code/{colnames(cont)[i]}.KEGG.csv")))
}
```

Test whether any of the genes in the BROAD sets are differentially expressed.

```{r}
library(ChAMP)
data(PathwayList)

keep <- sapply(PathwayList, function(x) any(x %in% z$genes$symbol))
idx <- suppressMessages(lapply(PathwayList[keep], function(x){
    tmp <- z$genes$gene_id[z$genes$symbol %in% x]
    tmp[!is.na(tmp)]
}))
  
for(i in 1:ncol(cont)){
    broad <- fry(v, index = idx, design = design, contrast = cont.matrix[,i])
    write.csv(go, here(glue("code/{colnames(cont)[i]}.BROAD.csv")))
}
```
